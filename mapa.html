<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alerta Salvador 5.0 - Mapa de Riscos</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: #cc0000;
            color: #ffffff;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }

        .site-title {
            font-size: 1rem;
            font-weight: bold;
            line-height: 1.2;
        }

        .site-title .main-title {
            font-size: 1rem;
            display: block;
        }

        .site-title .sub-title {
            font-size: 0.8rem;
            font-weight: normal;
            opacity: 0.9;
            display: block;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
        }

        .header-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .map-container {
            flex: 1;
            position: relative;
            z-index: 1;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .search-container {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 400px;
            z-index: 1000;
        }

        .search-box {
            width: 100%;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
        }

        .controls-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .control-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ffffff;
            color: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-size: 1.2rem;
            border: none;
            transition: transform 0.2s ease;
        }

        .control-button:hover {
            transform: scale(1.1);
        }

        .info-panel {
            position: absolute;
            bottom: 80px;
            left: 80px;
            background-color: #ffffff;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            max-width: 300px;
            z-index: 1002;
            display: none;
        }

        .info-panel.active {
            display: block;
        }

        .info-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333333;
        }

        .info-content {
            font-size: 0.9rem;
            color: #666666;
        }

        .risk-level {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .risk-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .high-risk {
            background-color: rgba(204, 0, 0, 0.7);
        }

        .medium-risk {
            background-color: rgba(255, 153, 0, 0.7);
        }

        .low-risk {
            background-color: rgba(255, 204, 0, 0.7);
        }

        .risk-text {
            font-weight: 500;
            color: #333333;
        }

        .risk-score {
            font-weight: bold;
            margin-left: 5px;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 70px;
            background-color: #ffffff;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }

        .legend.active {
            display: block;
        }

        .legend-title {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .legend-text {
            font-size: 0.8rem;
            color: #666666;
        }

        .area-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eeeeee;
        }

        .area-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }

        .area-stat-label {
            color: #666666;
        }

        .area-stat-value {
            font-weight: 500;
            color: #333333;
        }

        .area-recommendation {
            margin-top: 10px;
            padding: 8px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #333333;
        }


        .links-button {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #cc0000;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            font-size: 1.5rem;
            border: none;
            z-index: 1001;
            transition: transform 0.3s ease;
        }

        .links-button:hover {
            transform: scale(1.1);
        }

        .links-menu {
            position: absolute;
            bottom: 80px;
            left: 20px;
            background-color: #ffffff;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
            width: 250px;
        }

        .links-menu.active {
            display: block;
        }

        .links-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333333;
            border-bottom: 1px solid #eeeeee;
            padding-bottom: 5px;
        }

        .links-list {
            list-style: none;
        }

        .links-item {
            margin-bottom: 10px;
        }

        .links-item a {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #333333;
            font-size: 0.9rem;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .links-item a:hover {
            background-color: #f5f5f5;
        }

        .links-icon {
            margin-right: 10px;
            font-size: 1.2rem;
            width: 20px;
            text-align: center;
        }

        .popup-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333333;
            margin-bottom: 8px;
            text-align: center;
            border-bottom: 2px solid #cc0000;
            padding-bottom: 5px;
        }

        .popup-iras {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333333;
        }

        .risk-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: white;
            font-weight: bold;
        }

        .risk-badge.high {
            background-color: #cc0000;
        }

        .risk-badge.medium {
            background-color: #ff9900;
        }

        .risk-badge.low {
            background-color: #ffcc00;
            color: #333333;
        }

        .popup-stats {
            margin-bottom: 10px;
        }

        .popup-stats h4 {
            font-size: 0.9rem;
            color: #333333;
            margin-bottom: 5px;
        }

        .popup-stats p {
            font-size: 0.8rem;
            color: #666666;
            margin-bottom: 3px;
        }

        .stat-value {
            font-weight: bold;
            color: #cc0000;
        }

        .popup-recommendation {
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #333333;
            border-left: 3px solid #cc0000;
        }

        @media (max-width: 768px) {
            .search-container {
                width: 90%;
            }
            .info-panel {
                max-width: 250px;
                bottom: 70px;
                left: 70px;
            }
            .header-info {
                font-size: 0.8rem;
                gap: 10px;
            }
            .links-menu {
                width: 200px;
            }
            .site-title .main-title {
                font-size: 0.9rem;
            }
            .site-title .sub-title {
                font-size: 0.7rem;
            }
            .logo {
                width: 25px;
                height: 25px;
            }
        }

        @media (max-width: 480px) {
            .info-panel {
                max-width: 200px;
                bottom: 60px;
                left: 60px;
                padding: 10px;
            }
            .links-menu {
                width: 180px;
                bottom: 60px;
            }
            .site-title .main-title {
                font-size: 0.8rem;
            }
            .site-title .sub-title {
                font-size: 0.6rem;
            }
            .header {
                padding: 8px 10px;
            }
            .header-info {
                font-size: 0.7rem;
                gap: 8px;
            }
            .logo {
                width: 20px;
                height: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <img src="logo_seguranca.jpg" alt="üõ°Ô∏è" class="logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
            <span style="display:none; font-size: 24px;">üõ°Ô∏è</span>
            <h1 class="site-title">
                <span class="main-title">ALERTA SALVADOR 5.0</span>
                <span class="sub-title">SEGURAN√áA P√öBLICA</span>
            </h1>
        </div>
        <div class="header-info">
            <div class="header-item" id="current-date">
                <span>üìÖ</span>
                <span id="date-value">Carregando...</span>
            </div>
            <div class="header-item" id="current-time">
                <span>‚è∞</span>
                <span id="time-value">Carregando...</span>
            </div>
            <div class="header-item" id="current-weather">
                <span>üå§Ô∏è</span>
                <span id="weather-value">Carregando...</span>
            </div>
        </div>
    </div>
    
    <div class="map-container">
        <div id="map"></div>
        
        <div class="search-container">
            <input type="text" class="search-box" placeholder="Buscar por bairro ou local...">
        </div>
        
        <div class="controls-container">
            <button class="control-button" id="legendToggle" title="Legenda">‚ÑπÔ∏è</button>
            <button class="control-button" id="infoToggle" title="Informa√ß√µes">‚ùì</button>
        </div>
        
        <button class="links-button" id="linksToggle" title="Links √öteis">üîó</button>
        
        <div class="links-menu" id="linksMenu">
            <h3 class="links-title">Links √öteis</h3>
            <ul class="links-list">
                <li class="links-item">
                    <a href="https://youtu.be/9Nm1LRGYshQ?si=NrxqR-7DjfRJkq1a" target="_blank">
                        <span class="links-icon">üìπ</span>
                        <span>V√≠deo sobre viol√™ncia na Bahia</span>
                    </a>
                </li>
                <li class="links-item">
                    <a href="https://g1.globo.com/ba/bahia/noticia/2024/05/15/balanco-violencia-na-bahia-entre-janeiro-e-maio-de-2024.ghtml" target="_blank">
                        <span class="links-icon">üì∞</span>
                        <span>Mat√©ria do G1 sobre viol√™ncia</span>
                    </a>
                </li>
                <li class="links-item">
                    <a href="https://atarde.com.br/salvador/salvador-registra-1335-tiroteios-em-2024-saiba-bairros-mais-violentos-1307851" target="_blank">
                        <span class="links-icon">üñºÔ∏è</span>
                        <span>Estat√≠sticas de tiroteios</span>
                    </a>
                </li>
                <li class="links-item">
                    <a href="https://fogocruzado.org.br/" target="_blank">
                        <span class="links-icon">üîç</span>
                        <span>Instituto Fogo Cruzado</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="legend" id="legend">
            <h3 class="legend-title">N√≠veis de Risco</h3>
            <div class="legend-item">
                <div class="legend-color high-risk"></div>
                <span class="legend-text">Alto Risco (IRAS > 30)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color medium-risk"></div>
                <span class="legend-text">M√©dio Risco (IRAS 20-30)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color low-risk"></div>
                <span class="legend-text">Baixo Risco (IRAS < 20)</span>
            </div>
        </div>
        
        <div class="info-panel" id="infoPanel">
            <h3 class="info-title">Sobre o Alerta Salvador</h3>
            <div class="info-content">
                <p>O Alerta Salvador √© um sistema de monitoramento de √°reas de risco em Salvador, baseado em dados oficiais e not√≠cias recentes.</p>
                <p style="margin-top: 8px;">O √çndice de Risco Alerta Salvador (IRAS) utiliza dados brutos do Instituto Fogo Cruzado (01/01/2024 a 29/08/2025). Metodologia: Alto Risco (IRAS > 30), M√©dio Risco (20-30), Baixo Risco (< 20).</p>
                <p style="margin-top: 8px;">Clique nas √°reas coloridas para ver informa√ß√µes detalhadas sobre cada regi√£o.</p>
            </div>
        </div>
    </div>
    
    <audio id="clickSound" src="sounds/click.mp3" preload="auto"></audio>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Adicione na PRIMEIRA linha dentro do <script>
        if (performance.navigation.type === 1) {
            window.location.replace('index.html');
        }
        
        // Fun√ß√£o para tocar o som de clique
        function playClickSound() {
            try {
                const clickSound = document.getElementById('clickSound');
                if (clickSound) {
                    clickSound.currentTime = 0;
                    clickSound.play().catch(e => {
                        console.log('Som n√£o dispon√≠vel ou bloqueado pelo navegador');
                    });
                }
            } catch (error) {
                console.log('Erro ao reproduzir som:', error);
            }
        }
        // Fun√ß√£o para inicializar √°udio ap√≥s intera√ß√£o do usu√°rio
        function initializeAudio() {
            const clickSound = document.getElementById('clickSound');
            if (clickSound) {
                clickSound.play().then(() => {
                    clickSound.pause();
                    clickSound.currentTime = 0;
                }).catch(e => {
                    console.log('√Åudio n√£o suportado ou bloqueado');
                });
            }
        }
        
        // Adicionar som de clique a todos os elementos clic√°veis
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar √°udio na primeira intera√ß√£o
            document.body.addEventListener('click', initializeAudio, { once: true });
            document.body.addEventListener('touchstart', initializeAudio, { once: true });
            
            const specificButtons = document.querySelectorAll("#legendToggle, #infoToggle, #linksToggle");
            
            specificButtons.forEach(function(element) {
                element.addEventListener('click', playClickSound);
                element.addEventListener('touchstart', playClickSound);
            });
        });
        
        // Atualizar data e hora em tempo real
        function updateDateTime() {
            const now = new Date();
            // Formatar data: DD/MM/YYYY
            const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
            const formattedDate = now.toLocaleDateString('pt-BR', dateOptions);
            document.getElementById('date-value').textContent = formattedDate;
            // Formatar hora: HH:MM:SS
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const formattedTime = now.toLocaleTimeString('pt-BR', timeOptions);
            document.getElementById('time-value').textContent = formattedTime;
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // Atualizar clima (previs√£o para hoje)
        async function updateWeather() {
            try {
                const lat = -12.9777;
                const lon = -38.5016;
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_min,temperature_2m_max,precipitation_sum,weathercode&timezone=America%2FBahia`;

                const response = await fetch(url);
                const data = await response.json();
                if (data.daily && data.daily.time && data.daily.time.length) {
                    const hoje = new Date();
                    const hojeStr = hoje.toISOString().slice(0, 10);
                    let idxHoje = data.daily.time.findIndex(t => t === hojeStr);
                    if (idxHoje === -1) idxHoje = 0;

                    const tempMin = data.daily.temperature_2m_min[idxHoje].toFixed(1);
                    const tempMax = data.daily.temperature_2m_max[idxHoje].toFixed(1);
                    const chuva = data.daily.precipitation_sum[idxHoje];
                    const weatherCode = data.daily.weathercode[idxHoje];
                    const condition = {
                        0: "C√©u Limpo",
                        1: "Principalmente Limpo",
                        2: "Parcialmente Nublado",
                        3: "Nublado",
                        45: "N√©voa",
                        48: "N√©voa",
                        51: "Chuvisco Fraco",
                        53: "Chuvisco Moderado",
                        55: "Chuvisco Intenso",
                        61: "Chuva Fraca",
                        63: "Chuva Moderada",
                        65: "Chuva Forte",
                        80: "Pancadas Fracas",
                        81: "Pancadas Moderadas",
                        82: "Pancadas Fortes",
                    }[weatherCode] || "Tempo Indefinido";
                    
                    document.getElementById('weather-value').textContent =
                        `${condition}, ${tempMin}¬∞C/${tempMax}¬∞C, Precipita√ß√£o: ${chuva}mm`;
                } else {
                    document.getElementById('weather-value').textContent = "Indispon√≠vel";
                }
            } catch (error) {
                document.getElementById('weather-value').textContent = "Indispon√≠vel";
                console.error('Erro ao obter dados do clima:', error);
            }
        }
        setInterval(updateWeather, 18000);
        updateWeather();

        // ================================ NOVO C√ìDIGO IRAS ===========================
        // Fun√ß√£o para calcular o IRAS e determinar o n√≠vel de risco
        function calcularIRAS({
            tiroteiosRegistrados,
            vitimasFatais,
            pessoasBaleadasNaoFatais,
            operacoesPoliciais,
            disputasTerritoriais
        }) {
            const pesoTiroteios = 3;
            const pesoVitimasFatais = 3;
            const pesoBaleadasNaoFatais = 2;
            const pesoOperacoes = 1;
            const pesoDisputas = 2;
            const somaPesos = 11;

            const iras = (
                pesoTiroteios * tiroteiosRegistrados +
                pesoVitimasFatais * vitimasFatais +
                pesoBaleadasNaoFatais * pessoasBaleadasNaoFatais +
                pesoOperacoes * operacoesPoliciais +
                pesoDisputas * disputasTerritoriais
            ) / somaPesos;

            let riskLevel;
            if (iras > 30) {
                riskLevel = "high";
            } else if (iras >= 20 && iras <= 30) {
                riskLevel = "medium";
            } else {
                riskLevel = "low";
            }

            return { iras, riskLevel };
        }

        // Dados brutos das √°reas de risco
        const rawAreas = [
            {
                name: "Lobato",
                center: [-12.918201, -38.481219],
                radius: 600,
                stats: { tiroteios: 61, 
                        vitimas: 52, 
                        baleados: 18, 
                        operacoes: 1, 
                        disputas: 1 },
                recommendation: "√Årea com disputas territoriais. Evite circular √† noite. Mantenha-se atento em √°reas comerciais."
            },
            {
                name: "Pernambu√©s",
                center: [-12.970441, -38.464628],
                radius: 800,
                stats: { tiroteios: 65, 
                        vitimas: 41, 
                        baleados: 25, 
                        operacoes: 1,
                        disputas: 1 },
                recommendation: "Evite circular √† noite. Mantenha-se atento em √°reas comerciais. N√£o exiba objetos de valor."
            },
            {
                name: "Fazenda Grande do Retiro",
                center: [-12.941721, -38.480473],
                radius: 700,
                stats: { tiroteios: 58, 
                        vitimas: 45,
                        baleados: 20,
                        operacoes: 1,
                        disputas: 1 },
                recommendation: "√Årea com alta presen√ßa de fac√ß√µes. Evite circular sem conhecer a regi√£o. Prefira hor√°rios comerciais."
            },
            {
                name: "Beiru/Tancredo Neves",
                center: [-12.944604, -38.447130],
                radius: 800,
                stats: { tiroteios: 60,
                        vitimas: 38,
                        baleados: 22,
                        operacoes: 1,
                        disputas: 1 },
                recommendation: "Evite transitar sozinho. Mantenha-se atento a movimenta√ß√µes suspeitas. N√£o exiba objetos de valor."
            },
            {
                name: "Fazenda Coutos",
                center: [-12.846867, -38.461866],
                radius: 550,
                stats: { tiroteios: 49,
                        vitimas: 42,
                        baleados: 14,
                        operacoes: 1,
                        disputas: 1 },
                recommendation: "Evite circular √† noite. Mantenha-se atento em √°reas comerciais. N√£o exiba objetos de valor."
            },
            {
                name: "Val√©ria",
                center: [-12.861244, -38.436772],
                radius: 1200,
                stats: { tiroteios: 50,
                        vitimas: 40,
                        baleados: 15,
                        operacoes: 1, 
                        disputas: 1 },
                recommendation: "√Årea com presen√ßa de fac√ß√µes. Evite circular sem conhecer a regi√£o. Prefira hor√°rios comerciais."
            },
            {
                name: "Federa√ß√£o",
                center: [-12.995377, -38.502772],
                radius: 600,
                stats: { tiroteios: 45,
                        vitimas: 28,
                        baleados: 25,
                        operacoes: 1,
                        disputas: 1 },
                recommendation: "Mantenha-se atento em √°reas comerciais. Evite ruas menos movimentadas. N√£o exiba objetos de valor."
            },
            {
                name: "Itapu√£",
                center: [-12.93640, -38.36280],
                radius: 1000,
                stats: { tiroteios: 42,
                        vitimas: 35,
                        baleados: 16, 
                        operacoes: 1, 
                        disputas: 1 },
                recommendation: "Mantenha-se atento em √°reas tur√≠sticas. Evite praias desertas. N√£o exiba objetos de valor."
            },
            {
                name: "S√£o Crist√≥v√£o",
                center: [-12.908290, -38.360860],
                radius: 800,
                stats: { tiroteios: 40,
                        vitimas: 33, 
                        baleados: 15,
                        operacoes: 1,
                        disputas: 1 },
                recommendation: "Mantenha-se atento em √°reas comerciais. Evite circular √† noite. N√£o exiba objetos de valor."
            },
            {
                name: "Periperi",
                center: [-12.863425, -38.474542],
                radius: 800,
                stats: { tiroteios: 38,
                        vitimas: 30,
                        baleados: 12, 
                        operacoes: 1, 
                        disputas: 1 },
                recommendation: "Evite circular √† noite. Mantenha-se atento em √°reas comerciais. N√£o exiba objetos de valor."
            },
            {
                name: "Paripe",
                center: [-12.834079, -38.469006],
                radius: 800,
                stats: { tiroteios: 7, 
                        vitimas: 5,
                        baleados: 2, 
                        operacoes: 0,
                        disputas: 0 },
                recommendation: "Evite circular sem conhecer a regi√£o. Prefira hor√°rios comerciais. N√£o exiba objetos de valor."
            },
            {
                name: "Liberdade",
                center: [-12.946042, -38.493667],
                radius: 550,
                stats: { tiroteios: 5,
                        vitimas: 3, 
                        baleados: 2,
                        operacoes: 0,
                        disputas: 0 },
                recommendation: "Mantenha-se atento em √°reas comerciais. Evite ruas menos movimentadas. N√£o exiba objetos de valor."
            },
            {
                name: "IAPI",
                center: [-12.953257, -38.480146],
                radius: 550,
                stats: { tiroteios: 3,
                        vitimas: 2,
                        baleados: 1,
                        operacoes: 0,
                        disputas: 0 },
                recommendation: "Mantenha-se atento em √°reas comerciais. Evite ruas menos movimentadas. N√£o exiba objetos de valor."
            },
            {
                name: "Barra",
                center: [-13.00577, -38.52839],
                radius: 750,
                stats: { tiroteios: 1,
                        vitimas: 0, baleados: 1,
                        operacoes: 0,
                        disputas: 0 },
                recommendation: "Mantenha-se atento em √°reas tur√≠sticas. Evite praias desertas √° noite. N√£o exiba objetos de valor."
            },
            {
                name: "Pituba",
                center: [-13.00251, -38.45925],
                radius: 900,
                stats: { tiroteios: 2,
                        vitimas: 1,
                        baleados: 1,
                        operacoes: 0,
                        disputas: 0 },
                recommendation: "Mantenha-se atento em √°reas comerciais. Evite ruas menos movimentadas. N√£o exiba objetos de valor."
            },
            {
                name: "Itaigara",
                center: [-12.99252, -38.46784],
                radius: 600,
                stats: { tiroteios: 0, 
                        vitimas: 0,
                        baleados: 0,
                        operacoes: 0,
                        disputas: 0 },
                recommendation: "Mantenha-se atento em √°reas comerciais. Evite ruas menos movimentadas. N√£o exiba objetos de valor."
            },
            {
                name: "Engomadeira",
                center: [-12.949484, -38.456706],
                radius: 350,
                stats: { tiroteios: 4,
                        vitimas: 3, baleados: 1,
                        operacoes: 0,
                        disputas: 0 },
                recommendation: "Mantenha-se atento em √°reas comerciais. Evite ruas menos movimentadas. N√£o exiba objetos de valor."
            }
        ];

        // Gera o array final com IRAS e n√≠vel de risco calculados
        const riskAreas = rawAreas.map(area => {
            const resultado = calcularIRAS({
                tiroteiosRegistrados: area.stats.tiroteios,
                vitimasFatais: area.stats.vitimas,
                pessoasBaleadasNaoFatais: area.stats.baleados,
                operacoesPoliciais: area.stats.operacoes,
                disputasTerritoriais: area.stats.disputas
            });

            return {
                ...area,
                iras: resultado.iras,
                riskLevel: resultado.riskLevel
            };
        });

        function getRiskColor(riskLevel) {
            switch(riskLevel) {
                case 'high': return 'rgba(204, 0, 0, 0.3)';
                case 'medium': return 'rgba(255, 153, 0, 0.3)';
                case 'low': return 'rgba(255, 204, 0, 0.3)';
                default: return 'rgba(128, 128, 128, 0.3)';
            }
        }
        function getRiskBorderColor(riskLevel) {
            switch(riskLevel) {
                case 'high': return '#cc0000';
                case 'medium': return '#ff9900';
                case 'low': return '#ffcc00';
                default: return '#808080';
            }
        }
        function getRiskText(riskLevel) {
            switch(riskLevel) {
                case 'high': return 'Alto Risco';
                case 'medium': return 'M√©dio Risco';
                case 'low': return 'Baixo Risco';
                default: return 'Risco Desconhecido';
            }
        }
        function getRiskBadgeClass(riskLevel) {
            switch(riskLevel) {
                case 'high': return 'high';
                case 'medium': return 'medium';
                case 'low': return 'low';
                default: return 'low';
            }
        }

        // Inicializar o mapa
        var map = L.map('map').setView([-12.9714, -38.5014], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Adicionar c√≠rculos de risco ao mapa
        riskAreas.forEach(function(area) {
            var circle = L.circle(area.center, {
                color: getRiskBorderColor(area.riskLevel),
                fillColor: getRiskColor(area.riskLevel),
                fillOpacity: 0.3,
                radius: area.radius,
                weight: 2
            }).addTo(map);

            // Criar conte√∫do do popup
            var riskText = getRiskText(area.riskLevel);
            var riskBadgeClass = getRiskBadgeClass(area.riskLevel);

            var popupContent = `
                <div class="popup-title">${area.name}</div>
                <div class="popup-iras">
                    IRAS: ${area.iras.toFixed(2)}
                    <span class="risk-badge ${riskBadgeClass}">${riskText}</span>
                </div>
                <div class="popup-stats">
                    <h4>üìä Estat√≠sticas de Seguran√ßa (2024-2025)</h4>
                    <p>üî´ Tiroteios registrados: <span class="stat-value">${area.stats.tiroteios}</span></p>
                    <p>‚ö∞Ô∏è V√≠timas fatais: <span class="stat-value">${area.stats.vitimas}</span></p>
                    <p>ü©∏ Pessoas baleadas: <span class="stat-value">${area.stats.baleados}</span></p>
                    <p>üöî Opera√ß√µes policiais: <span class="stat-value">${area.stats.operacoes}</span></p>
                    <p>‚öîÔ∏è Disputas territoriais: <span class="stat-value">${area.stats.disputas}</span></p>
                </div>
                <div class="popup-recommendation">
                    <strong>Recomenda√ß√£o:</strong> ${area.recommendation}
                </div>
            `;
            circle.bindPopup(popupContent);
        });

        // Busca por √°rea
        document.querySelector('.search-box').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = this.value.toLowerCase();
                const foundArea = riskAreas.find(area => 
                    area.name.toLowerCase().includes(searchTerm)
                );
                if (foundArea) {
                    map.setView(foundArea.center, 15);
                    map.eachLayer(function(layer) {
                        if (layer instanceof L.Circle) {
                            const center = layer.getLatLng();
                            if (Math.abs(center.lat - foundArea.center[0]) < 0.001 && 
                                Math.abs(center.lng - foundArea.center[1]) < 0.001) {
                                layer.openPopup();
                            }
                        }
                    });
                } else {
                    const searchResult = document.createElement('div');
                    searchResult.style.cssText = `
                        position: absolute;
                        top: 60px;
                        left: 50%;
                        transform: translateX(-50%);
                        background-color: #fff3cd;
                        border: 1px solid #ffeaa7;
                        border-radius: 5px;
                        padding: 10px 15px;
                        z-index: 1001;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                        max-width: 400px;
                        text-align: center;
                    `;
                    searchResult.innerHTML = `
                        <strong>√Årea n√£o catalogada</strong><br>
                        <small>A √°rea "${this.value}" n√£o est√° em nosso banco de dados atual.</small><br>
                        <small style="color: #666;">√Åreas dispon√≠veis: ${riskAreas.map(a => a.name).join(', ')}</small>
                    `;
                    const existingResult = document.querySelector('.search-result-message');
                    if (existingResult) existingResult.remove();
                    searchResult.classList.add('search-result-message');
                    document.body.appendChild(searchResult);
                    setTimeout(() => searchResult.remove(), 5000);
                }
            }
        });
        
        // Pain√©is de info/legenda/links
        document.getElementById('legendToggle').addEventListener('click', function() {
            document.getElementById('legend').classList.toggle('active');
        });
        document.getElementById('infoToggle').addEventListener('click', function() {
            document.getElementById('infoPanel').classList.toggle('active');
        });
        document.getElementById('linksToggle').addEventListener('click', function() {
            document.getElementById('linksMenu').classList.toggle('active');
        });
        
        //==================== NOVO C√ìDIGO PARA POPUPS E SOM ====================
        // Pain√©is de info/legenda/links
        document.getElementById('legendToggle').addEventListener('click', function() {
            document.getElementById('legend').classList.toggle('active');
        });
        document.getElementById('infoToggle').addEventListener('click', function() {
            document.getElementById('infoPanel').classList.toggle('active');
        });
        document.getElementById('linksToggle').addEventListener('click', function() {
            document.getElementById('linksMenu').classList.toggle('active');
        });
        
        //==================== NOVO C√ìDIGO PARA POPUPS E SOM ====================
        document.addEventListener('DOMContentLoaded', function() {
            const legendBtn = document.getElementById('legendToggle');
            const infoBtn = document.getElementById('infoToggle');
            const linksBtn = document.getElementById('linksToggle');
            const legend = document.getElementById('legend');
            const infoPanel = document.getElementById('infoPanel');
            const linksMenu = document.getElementById('linksMenu');

            function closeAllPopups() {
                legend.classList.remove('active');
                infoPanel.classList.remove('active');
                linksMenu.classList.remove('active');
            }
            
            legendBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (legend.classList.contains('active')) {
                    legend.classList.remove('active');
                } else {
                    closeAllPopups();
                    legend.classList.add('active');
                }
                playClickSound();
            });
            
            infoBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (infoPanel.classList.contains('active')) {
                    infoPanel.classList.remove('active');
                } else {
                    closeAllPopups();
                    infoPanel.classList.add('active');
                }
                playClickSound();
            });
            
            linksBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (linksMenu.classList.contains('active')) {
                    linksMenu.classList.remove('active');
                } else {
                    closeAllPopups();
                    linksMenu.classList.add('active');
                }
                playClickSound();
            });
        
        document.body.addEventListener('click', function(e) {
                if (
                    !legend.contains(e.target) && e.target !== legendBtn &&
                    !infoPanel.contains(e.target) && e.target !== infoBtn &&
                    !linksMenu.contains(e.target) && e.target !== linksBtn
                ) {
                    closeAllPopups();
                }
            });
            // Adicionar som de clique aos bot√µes
            [legendBtn, infoBtn, linksBtn].forEach(function(element) {
                element.addEventListener('touchstart', playClickSound);
            });
        });
        
        function playClickSound() {
            const clickSound = document.getElementById('clickSound');
            if (clickSound) {
                clickSound.currentTime = 0;
                clickSound.play().catch(() => {});
            }
        }
        
            //legendBtn.addEventListener('click', function(e) {
                //e.stopPropagation();
                //if (legend.classList.contains('active')) {        
                    //legend.classList.remove('active');
                //} else {
            
            //document.body.addEventListener('click', function initAudio() {
                //playClickSound();
                //document.body.removeEventListener('click', initAudio);
            //}, { once: true });
        //};
        
        function playClickSound() {
            const clickSound = document.getElementById('clickSound');
            if (clickSound) {
                clickSound.currentTime = 0;
                clickSound.play().catch(() => {});
            }
        }
        
            //legendBtn.addEventListener('click', function(e) {
                //e.stopPropagation();
                //if (legend.classList.contains('active')) {        
                    //legend.classList.remove('active');
                //} else {
            
            //document.body.addEventListener('click', function initAudio() {
                //playClickSound();
                //document.body.removeEventListener('click', initAudio);
            //}, { once: true });
        //};
    </script>
</body>
</html>

       
